FROM golang:1.21-bullseye AS builder
RUN sudo apt-get update && apt-get install build-essential tzdata
WORKDIR /myapp
COPY ./app ./app
COPY ./aws ./aws
COPY ./crypto ./crypto
COPY ./db ./db
COPY ./errors ./errors
COPY ./kafka ./kafka
COPY ./log ./log
COPY ./utils ./utils
COPY ./testutils ./testutils
COPY ./go.mod ./go.mod

RUN go mod tidy


FROM debian:bullseye-slim AS runner
RUN apt-get install build-essential tzdata
WORKDIR /service


FROM builder AS sample
WORKDIR /myapp/db/mongo/csfle/test/http
RUN go build -tags cse musl -o /app -ldflags '-linkmode external -w -extldflags "-static"'

FROM runner AS kafka
COPY --from=kafkabuilder /app /service/app
ENTRYPOINT ["/service/app"]
